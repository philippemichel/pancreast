---
title: "Cancer du Pancréas"
subtitle: "Rapport statistique -- v1.1"
author: 
    - name: "Dr Philippe MICHEL"
      affiliations:
        name: "Hôpital NOVO"
        department: "Unité de Soutien à la Recherche Clinique"
lang: fr
date: today
date-format: "DD/MM/YYYY"
format: 
  titlepage-pdf:
    titlepage: bg-image
    titlepage-bg-image: "novo_usrc.png"
    logo-space-after: "0\\baselineskip"
    documentclass: scrreprt
    classoption: ["oneside", "open=any"]
    number-sections: true
    titlepage-footer: "**Dr Nelson TRELLES** \\newline  Chirurgie viscérale -- Hôpital NOVO (Site Pontoise)\\newline \\newline Imapct de l'évolution des recommandations des nouvelles chimiotérapies dans le pronostic de l'adénocarinome du pancréas\\newline Étude rétrospective sur registre\\newline \\today"
titlepage-theme:
    title-fontstyle: ["Huge", "bfseries"]
    title-color: novo
    subtitle-color: novo
    subtitle-fontstyle: ["huge"]
    logo-size: "0.2\\textheight"
    vrule-width: "0.1cm"
    vrule-color: novo
include-in-header:
      text: |
        \usepackage{siunitx}
        \definecolor{novo}{HTML}{27484b}
jss-pdf:
    keep-tex: true   
pdf-engine: lualatex
keep-tex: true
number-sections: true
toc: true
lof: true
lot: true
mainfont: Faune
mainfontoptions:
  - Numbers=OldStyle
  - Ligatures=TeX
sansfont: Myriad Pro
sansfontoptions:
  - Ligatures=TeX
fig-cap-location: bottom
tbl-cap-location: top
classoption: [french]
papersize: a4paper
editor: source
bibliography: stat.bib
cite-method: biblatex
csl: jama.csl
#reference-location: margin
#citation-location: margin
license: "MIT"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, cache = FALSE) 
expx <- TRUE
classeur <- "pancreask2.xls"
```

```{r}
#| label: lib

library(baseph)
library(survminer)
library(survival)
library(janitor)
library(corrplot)
library(lubridate)
library(Rcpp)
library(tidyverse)
library(lubridate)
library(labelled)
library(kableExtra)
library(forestmodel)
library(epiDisplay)
library(confintr)
library(missMDA)
library(colorspace)
library(visdat)
library(gtsummary)
library(FactoMineR)
library(factoextra)
#
# Écrivons les chiffres en français
#
theme_gtsummary_language(language = "fr", decimal.mark = ",", big.mark = " ")
```


```{r}
#| label: import

tt <-
  read_csv2(
    "datas/pancreas.csv",
    na = c("NA", "nk", " ", "", "na", "nd"),
    show_col_types = FALSE
  ) |> 
  mutate_if(is.character, as.factor)  |>
  janitor::clean_names() |>
  dplyr::filter(str_sub(histologie, 1, 14) == "adenocarcinome") |>
  mutate(histologie = factor(histologie)) |>
  
  mutate(across(starts_with("date"), dmy)) |>
  mutate(suivi = as.numeric(date_dernieres_nouvelle - date_de_diagnostic) /
           30.44) |>
  mutate(dcd = if_else(decede == "oui", 1, 0)) |>
  #  mutate(histologie = fct_lump(histologie, n = 5)) |>
  dplyr::select(-code_anapath) |>
  mutate(c_n = as.factor(c_n)) |>
  mutate_at(vars(starts_with("ordre")), as.factor) |>
  mutate(tranche_age = str_replace_all(tranche_age, "-", " à "))
#
names(tt) <- stringr::str_replace_all(names(tt), "_", ".")

## Recodage de tt$tranche.age en tt$tranche.age
tt$tranche.age <- tt$tranche.age |> 
  fct_recode(
    "20 à 29" = "20 à 24",
    "20 à 29" = "25 à 29",
    "30 à 39" = "30 à 34",
    "30 à 39" = "35 à 39",
    "40 à 49" = "40 à 44",
    "40 à 49" = "45 à 49",
    "50 à 59" = "50 à 54",
    "50 à 59" = "55 à 59",
    "60 à 69" = "60 à 64",
    "60 à 69" = "65 à 69",
    "70 à 79" = "70 à 74",
    "70 à 79" = "75 à 79",
    "80 et +" = "80 à 84",
    "80 et +" = "85+"
  )

#
## Réordonnancement de tt$metastase
tt$metastase <- tt$metastase %>%
  fct_relevel(
    "non",
    "Foie",
    "Carcinose ou pleuresie",
    "Cerveau",
    "Ganglion a distance",
    "Os",
    "Peau",
    "poumon",
    "surrenale",
    "Multiple"
  )


zz <- tt |> 
   dplyr::filter(suivi <61) |> 
   group_by(chir) |> 
   summarise(n())
```

\bigskip


\bigskip

La population comprend 3138 patients dans la base. Après sélection pour ne garder que les adénocarcinomes il reste `r nrow(tt)` cas pour `r ncol(tt)`.

En raison du faible nombre de patient passé ce cap, tous les calculs & graphiques de survie seront réalisés sur cinq ans après le diagnostic soit `r zz[[2]][1] + zz[[2]][2]` cas (`r zz[[2]][2]` chirurgicaux & `r zz[[2]][1]` non chirurgicaux).

```{r}
#| label: groupchir
dchim <- c("10/11/2001", "17/01/2007","20/12/2018")
dchim <- dmy(dchim)
tta <- tt |> 
  dplyr::filter(chir  == "oui") |> 
  mutate(chim = "FOLFIRINOX")
zz <- which(tta$date.de.diagnostic < dchim[3])
tta$chim[zz] <-  "GEMZAR"
zz <- which(tta$date.de.diagnostic < dchim[2])
tta$chim[zz] <-  "5FU"
zz <- which(tta$date.de.diagnostic < dchim[1])
tta$chim[zz] <-  "Aucune"
## Réordonnancement de tta$chim
tta$chim <- tta$chim %>%
  fct_relevel(
    "Aucune", "5FU", "GEMZAR", "FOLFIRINOX"
  )
var_label(tta$chim) <-"Chimiothérapie"
```

```{r}
#| label: groupnchir
dchim <- dmy("01/01/2010")
ttb <- tt |> 
  dplyr::filter(chir  != "oui") |> 
  mutate(chim = as.factor(if_else(date.de.diagnostic > dchim,"2010 et après", "avant 2010")))
  ## Réordonnancement de ttb$chim
ttb$chim <- ttb$chim %>%
  fct_relevel(
    "avant 2010", "2010 et après"
  )

```


# Qualité de la base de données

L'échantillon comporte `r nrow(tt)` cas pour `r ncol(tt)` variables.

## Données manquantes

```{r}
#| label: manq
#| fig-cap: Données manquantes

vis_miss(tt, show_perc_col = TRUE)
```

# Description

## Patient
```{r}
#| label: despat
#| tbl-cap: Tableau descriptif -- Patient

tt |>
  dplyr::select(3, 4, 8:15) |>
  tbl_summary(missing = "no") |>
  modify_header(label ~ " ") |>
  bold_labels() |>
  add_n() |>
  gexptabph(
    lg = TRUE,
    exp = expx,
    nomfich = classeur,
    nomsheet = "descpat"
  )
```

```{r}
#| label: pyr
#| fig-cap: Pyramide des âges

      ggplot(tt) +
      aes(x = tranche.age, fill = sexe) +
      geom_bar(data = subset(tt, sexe == "femme"),
               aes(y = ..count.. * (-1))) +
      geom_bar(data = subset(tt, sexe == "homme")) +
      geom_hline(yintercept = 0)+
      scale_fill_manual(values = c("pink", "lightblue")) +
      coord_flip() +
      labs(title = "Pyramide des âges") +
      theme_light() +
      theme(
        plot.title = element_text(size = 16, face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x =  element_blank(),
        axis.text.y =  element_text(size = 12),
        legend.position = "right",
        legend.title = element_blank()
      )
```
## Traitement

```{r}
#| label: desctt
#| tbl-cap: Tableau descriptif -- Traitements

tt |> 
  dplyr::select(16:31) |> 
  tbl_summary(missing = "no") |> 
    modify_header(label ~ " ") %>%
  bold_labels() |> 
  add_n() |> 
  pexptabph(lg = TRUE, exp = expx, nomfich = classeur, nomsheet = "desctt")
```

\clearpage

# Patients chirurgicaux vs non chirurgicaux

```{r}
#| label: tabchirnonchir
#| fig-cap: Survie -- Patients  chirurgicaux ou non
#| fig-asp: 1

ff <- Surv(tt$suivi, tt$dcd)
ffx <- survfit(ff ~ chir , data = tt)
fflr <- survdiff(ff ~ chir , data = tt)

coxph(ff ~ chir , data = tt) |> 
    tbl_regression(exponentiate = TRUE) |> 
  modify_header(label ~ " ") %>%
  bold_labels() |> 
  bold_p() |> 
  pexptabph(lg = TRUE, exp = expx, nomfich = classeur, nomsheet = "coxchirnchir")
```

```{r}
#| label: chirnonchir
#| tbl-cap: patients chirurgicaux vs non chirurgicaux

tt |>
  dplyr::select(3,4, 8:17,19:24,26,30,31) |>
  tbl_summary(missing = "no", by = "chir") |>
  modify_header(label ~ " ") |>
  bold_labels() |>
  add_n() |>
  add_p() |> 
  bold_p() |> 
  gexptabph(
    lg = TRUE,
    exp = expx,
    nomfich = classeur,
    nomsheet = "chirnonchir"
  )
```

```{r}
#| label: figchirnonchir
#| fig-cap: Courbe de survie -- Patients  chirurgicaux ou non
#| fig-asp: 1

ggsurvplot(
  ffx,
  data = tt,
  palette = "lancet",
  pval = TRUE,
  pval.coord = c(36,0.75),
  ggtheme = theme_light(),
  title = "Patients chirurgicaux vs non chirurgicaux",
  subtitle = "Courbe de survie",
  surv.median.line = "hv",
  conf.int = TRUE,
  legend.labs = c("Non chirurgical","Chirurgical"),
  legend = "top",
  legend.title = "Traitement ",
  risk.table.title = "n",
  surv.scale = "percent",
  xlab = "mois",
  ylab = "Survie (%)",
  break.x.by = 12,
  risk.table = TRUE,
  xlim = c(0,60),
 tables.height = 0.2,
 tables.theme = theme_cleantable()
)
```

#  patients chirurgicaux

`r nrow(tta)` patients ont été opérés soit `r round(100*nrow(tta)/nrow(tt),1)`%  de la population. La répartition entre les différentes chimiothérapies adjuvantes (définies par la période) est de : 

```{r}
#| label: tabchimchir
#| tbl-cap: Chimiothérapies néoadjuvantes
zz <- table(tta$chim)
aa <- round(prop.table(zz)*100,1)
zz <- cbind(zz,aa)
colnames(zz) <- c("n","%")
kbl(zz, booktabs = T) |> 
  kable_styling(latex_options = c("HOLD_position"))
```

```{r}
#| label: chirdesc
#| tbl-cap: patients chirurgicaux

tta |>
  dplyr::select(3,4, 8:31,34) |>
  tbl_summary(missing = "no", by = chim) |>
  modify_header(label ~ " ") |>
  bold_labels() |>
  add_n() |>
  add_p() |> 
  bold_p() |> 
  pexptabph(
    lg = TRUE,
    exp = expx,
    nomfich = classeur,
    nomsheet = "chirdesc"
  ) |> 
  kable_styling(font_size = 8) |> 
  landscape()
```

```{r}
#| label: courbe1
#| fig-cap: Courbe de survie - patients chirurgicaux
#| fig-asp: 1

ff <- Surv(tta$suivi, tta$dcd)
ffx <- survfit(ff ~ 1 , data = tta)
ggsurvplot(
  ffx,
  data = tta,
  palette = "lancet",
  test.for.trend = TRUE,
  ggtheme = theme_light(),
  title = "Patients chirurgicaux",
  subtitle = "Courbe de survie",
  surv.median.line = "hv",
  legend.labs = "",
  conf.int = TRUE,
  surv.scale = "percent",
  xlab = "mois",
  ylab = "Survie (%)",
  legend = "none",
  risk.table.title = "n",
  break.x.by = 12,
  xlim = c(0,60),
      risk.table = TRUE,
 tables.height = 0.15,
 tables.theme = theme_cleantable()
) 
```

```{r}
#| label: chirchimiofig
#| fig-cap: Courbes de survie selon la chimiothérapie adjuvante
#| fig-asp: 1

ff <- Surv(tta$suivi, tta$dcd)
survfit(ff ~ chim , data = tta) |>
  ggsurvplot(
    data = tta,
    palette = "lancet",
    pval = TRUE,
    pval.coord = c(36,0.75),
    test.for.trend = TRUE,
    ggtheme = theme_light(),
    title = "Patients chirurgicaux",
    subtitle = "Courbe de survie selon la chimiothérapie adjuvante",
    legend.title = "",
    legend.labs = levels(tta$chim),
    risk.table.title = "n",
    surv.median.line = "hv",
    conf.int = FALSE,
    surv.scale = "percent",
    xlab = "mois",
    ylab = "Survie (%)",
    break.x.by = 6,
    xlim = c(0,60),
    risk.table = TRUE,
 tables.height = 0.25,
 tables.theme = theme_cleantable()
  ) 
```
\clearpage

La comparaison est faite pour chaque item vs `Aucune chimiothérapie` mais le groupe `FOLFIRINOX` ne peut être analysé (la courbe croise les autre courbes & peu de cas passé 30 mois). Les deux groupes font mieux que l'absence de chimiothérapie. On compare ensuite `5FU` & `GEMZAR`.


```{r}
#| label: coxchirfig1
#| tbl-cap: Survie des patients chirurgicaux - 5FU vs GEMZAR
#| fig-asp: 1

ttx <- tta |> 
  dplyr::filter(chim %in% c("5FU","GEMZAR")) |> 
  mutate(chim = factor(chim)) |> 
  dplyr::filter(suivi<61)

#
ff <- Surv(ttx$suivi, ttx$dcd)
#
survfit(ff ~ chim , data = ttx) |>
  ggsurvplot(
    data = ttx,
    palette = "lancet",
    ggtheme = theme_light(),
    title = "Patients chirurgicaux - 5FU vs GEMZAR",
    subtitle = "Courbes de survie",
    legend.title = "Traitement ",
    legend.labs = levels(ttx$chim),
    pval = TRUE,
    pval.coord = c(36,0.75),
    risk.table.title = "n",
    surv.median.line = "hv",
    conf.int = TRUE,
    surv.scale = "percent",
    xlab = "mois",
    ylab = "Survie (%)",
    break.x.by = 6,
    risk.table = TRUE,
 tables.height = 0.2,
 tables.theme = theme_cleantable()
  ) 
```


```{r}
#| label: coxchir2
#| tbl-cap: Survie des patients chirurgicaux - 5FU vs GEMZAR



coxph( Surv(ttx$suivi, ttx$dcd)~ chim , data = ttx) |> 
  tbl_regression(exponentiate = TRUE) |> 
  modify_header(label ~ " ") %>%
  bold_labels() |> 
  bold_p() |> 
  pexptabph(lg = TRUE, exp = expx, nomfich = classeur, nomsheet = "chir5fugemz")
```



Il y a une différence significative entre `5FU` & `GEMZAR` pour la survie dans cet échantillon.

## Analyse multivariée

On réalise une recherche de facteurs pronostics en incluant : 

- l'âge
- la présence de métastase
- le grade histologique
- le nombre de ganglions envahis

Les items T & N de la classification TNM n'a pas été retenus dans le modèle final. L'âge ne semble pas être lié au pronostic (La différence significative sur un seul niveau est anecdotique, probablement fortuite).

```{r}
#| label: coxchir3
#| tbl-cap: Survie des patients chirurgicaux  - Facteurs de risque

ttx <- ttx |> 
  mutate(meta = if_else(metastase == "non", "Non", "Oui" ))
ff <- Surv(ttx$suivi, ttx$dcd)
coxph(ff ~ tranche.age + meta + grade + ganglions.envahis ,data = ttx) |> tbl_regression(exponentiate = TRUE) |> 
  modify_header(label ~ " ") %>%
  bold_labels() |> 
  bold_p() |> 
  pexptabph(lg = TRUE, exp = expx, nomfich = classeur, nomsheet = "coxchir")
``` 

```{r}
#| label: metachir3
#| tbl-cap: Survie des patients chirurgicaux - Métastases
#| fig-asp: 1

survfit(ff ~ meta  , data = ttx) |>
  ggsurvplot(
    data = ttx,
    palette = "lancet",
    ggtheme = theme_light(),
    title = "Patients chirurgicaux",
    subtitle = "Courbe de survie",
    legend.title = "Présence de métastase",
    legend.labs = c("Non", "Oui"),
    pval = TRUE,
    pval.coord = c(36,0.75),
    risk.table.title = "n",
    surv.median.line = "hv",
    conf.int = TRUE,
    surv.scale = "percent",
    xlab = "mois",
    ylab = "Survie (%)",
    break.x.by = 6,
    xlim = c(0, 60),
    risk.table = TRUE,
 tables.height = 0.2,
 tables.theme = theme_cleantable()
  )
```

```{r}
#| label: gradechir3
#| tbl-cap: Survie des patients chirurgicaux - grade histologique
#| fig-asp: 1

survfit(ff ~ grade  , data = ttx) |> 
  ggsurvplot(
    data = ttx,
    palette = "lancet",
    pval = TRUE,
    pval.coord = c(36,0.75),
    ggtheme = theme_light(),
    title = "Patients chirurgicaux",
    subtitle = "Courbe de survie",
    legend.title = "Grade histologique",
    legend.labs = 1:4,
    risk.table.title = "n",
    surv.median.line = "hv",
    conf.int = FALSE,
    surv.scale = "percent",
    xlab = "mois",
    ylab = "Survie (%)",
    break.x.by = 6,
    xlim = c(0, 48),
    risk.table = TRUE,
 tables.height = 0.2,
 tables.theme = theme_cleantable()
  )
```

\clearpage

# Patients non chirurgicaux

```{r}
#| label: pal

pal <- ttb |> 
  group_by(traitement) |> 
  summarise(n())
zzn <- pal[[2,2]]

ttb <- ttb |> 
  dplyr::filter(traitement != "Palliatif") 
```


`r nrow(ttb)` patients n'ont pas été opérés soit `r round(100*nrow(ttb)/nrow(tt),1)`%  de la population. Parmi ceux-ci, `r zzn` étaient considérés d’emblée comme en traitement palliatif. On exclu ces patients palliatifs.

```{r}
#| label: tabchimnchir
#| tbl-cap: Patients non chirurgiacux - Période
zz <- table(ttb$chim)
aa <- round(prop.table(zz)*100,1)
zz <- cbind(zz,aa)
colnames(zz) <- c("n","%")
kbl(zz, booktabs = T) |> 
  kable_styling(latex_options = c("HOLD_position"))
```

```{r}
#| label: nchirdesc
#| tbl-cap: Patients non chirurgicaux

ttb |>
  dplyr::select(3,4, 8:15,19:26,30,31,34) |>
  tbl_summary(missing = "no", by = chim) |>
  modify_header(label ~ " ") |>
  bold_labels() |>
  add_n() |>
  add_p() |> 
  bold_p() |> 
  gexptabph(
    lg = TRUE,
    exp = expx,
    nomfich = classeur,
    nomsheet = "nchirdesc"
  ) |> 
   kable_styling(font_size = 8)
```

```{r}
#| label: courbepal1
#| fig-cap: Courbe de survie -- Patients non chirurgicaux
#| fig-asp: 1

  

ff <- Surv(ttb$suivi, ttb$dcd)
ffx <- survfit(ff ~ 1 , data = ttb)
ggsurvplot(
  ffx,
  data = ttb,
  palette = "lancet",
  pval = TRUE,
  pval.coord = c(36,0.75),
  ggtheme = theme_light(),
  title = "Patients non chirurgicaux",
  subtitle = "Courbe de survie",
  surv.median.line = "hv",
  conf.int = TRUE,
  legend = "none",
  risk.table.title = "n",
  surv.scale = "percent",
  xlab = "mois",
  ylab = "Survie (%)",
  xlim = c(0,60),
  break.x.by = 12,
  risk.table = TRUE,
 tables.height = 0.2,
 tables.theme = theme_cleantable()
) 
```

```{r}
#| label: courbepal2
#| fig-cap: Courbes de survie -- Patients non chirurgicaux 
#| fig-asp: 1

  

ff <- Surv(ttb$suivi, ttb$dcd)
ffx <- survfit(ff ~ chim , data = ttb)
ggsurvplot(
  ffx,
  data = ttb,
  palette = "lancet",
  pval = TRUE,
  pval.coord = c(36,0.75),
  ggtheme = theme_light(),
  title = "Patients non chirurgicaux - ",
  subtitle = "Courbe de survie",
  surv.median.line = "hv",
  conf.int = TRUE,
      legend.title = "Période",
    legend.labs = levels(ttb$chim),
  legend = "top",
  risk.table.title = "n",
  surv.scale = "percent",
  xlab = "mois",
  ylab = "Survie (%)",
  break.x.by = 12,
  xlim = c(0,60),
  risk.table = TRUE,
 tables.height = 0.2,
 tables.theme = theme_cleantable()
) 
```


## Analyse multivariée

On réalise une recherche de facteurs pronostics en incluant : 

- l'âge
- la présence de métastase
- le nombre de ganglions envahis

Les items T & N de la classification TNM n'a pas été retenus dans le modèle final. L'âge ne semble pas être lié au pronostic. Le grade histologique n'a pu être analysé en raison d'un taux de remplissage trop faible dans les dossiers les plus anciens. 

```{r}
#| label: coxnchir3
#| tbl-cap: Survie des patients non chirurgicaux  - Facteurs de risque
#| fig-asp: 1

ttb <- ttb |> 
  mutate(meta = if_else(metastase == "non", "Non", "Oui" ))
ff <- Surv(ttb$suivi, ttb$dcd)
coxph(ff ~ tranche.age + meta +  ganglions.envahis + chim,  data = ttb) |> 
  tbl_regression(exponentiate = TRUE) |> 
  modify_header(label ~ " ") %>%
  bold_labels() |> 
  bold_p() |> 
  pexptabph(lg = TRUE, exp = expx, nomfich = classeur, nomsheet = "coxnonchir")
``` 

```{r}
#| label: metanchir3
#| tbl-cap: Survie des patients non chirurgicaux - Métastases
#| fig-asp: 1

survfit(ff ~ meta  , data = ttb) |>
  ggsurvplot(
    data = ttb,
    palette = "lancet",
    pval = TRUE,
    pval.coord = c(36,0.75),
    ggtheme = theme_light(),
    title = "Patients non chirurgicaux",
    subtitle = "Courbe de survie",
    legend.title = "Présence de métastase",
    legend.labs = c("Non", "Oui"),
    risk.table.title = "n",
    surv.median.line = "hv",
    conf.int = TRUE,
    surv.scale = "percent",
    xlab = "mois",
    ylab = "Survie (%)",
    break.x.by = 6,
    xlim = c(0, 48),
    risk.table = TRUE,
 tables.height = 0.2,
 tables.theme = theme_cleantable()
  )
```
# Technique
Dans les tableaux descriptifs les données discrètes ont été présentées en pourcentage. Les données numériques ont été présentées par leur moyenne. 

La survie a été étudiée sur un intervalle de cinq ans après le diagnostic. Les courbes ont été tracées par la méthode de Kaplan-Meyer. Les comparaisons deux à deux ont été analysées par la méthode du Log-Rank puis une analyse en régression par la méthode de Cox a été réalisée.

L'analyse statistique a été réalisée avec le logiciel **R** [@rstat] & diverses librairies en particulier celles du `tidyverse` [@tidy] & `baseph` [@baseph].

